<!--
title: 【apache】ログファイルの管理と解析：virtualhostでアクセスログを取得する手順
tags: apache,virtualhost
id: 
private: false
-->

## apacheについて初心者エンジニアに向けて、ログファイルの管理と解析：virtualhostでアクセスログを取得する手順

こんにちは。今回は、apacheについて初心者エンジニアに向けて、ログファイルの管理と解析について解説します。特に、virtualhostを使用してアクセスログを取得する手順について詳しく説明していきます。

apacheは非常に人気のあるwebサーバーソフトウェアであり、多くのウェブ開発者やシステム管理者に利用されています。アクセスログは、ウェブサイトのアクセス履歴やユーザーの行動を追跡するために重要な情報です。ログファイルの管理と解析は、ウェブサイトのパフォーマンスの評価やセキュリティ対策において非常に重要な役割を果たします。

以下では、apacheのアクセスログの有効化方法から、ログの保存場所やカスタマイズ手順、ログのローテーションと削除方法、ログの解析ツールや重要な情報の抽出方法、そしてリモートipアドレスのブロックとセキュリティ対策のためのログ分析について順を追って解説していきます。

## アクセスログの有効化とフォーマット設定方法

まず最初に、apacheのアクセスログの有効化とフォーマット設定方法について説明します。

apacheでは、デフォルトでアクセスログが有効になっている場合がありますが、確認する必要があります。アクセスログが有効になっていない場合は、以下の手順で有効化することができます。

まず、apacheの設定ファイル（通常はhttpd.confやapache2.conf）を開きます。設定ファイルの場所は、使用しているapacheのバージョンやosによって異なる場合があります。

設定ファイルを開いたら、以下のような行を見つけてコメントアウト（「#」で始まる行）を解除します。

```
# customlog "logs/access_log" combined
```

コメントアウトを解除したら、apacheを再起動します。これでアクセスログが有効化されました。

次に、アクセスログのフォーマットを設定する方法について説明します。アクセスログのフォーマットは、ユーザーの行動やipアドレスなどの情報をどのように表示するかを定義します。

apacheの設定ファイルを開き、以下のような行でフォーマットを指定します。

```
logformat "%h %l %u %t \"%r\" %>s %b \"%{referer}i\" \"%{user-agent}i\"" combined
customlog "logs/access_log" combined
```

上記の例では、以下の情報を含むようにログのフォーマットが指定されています。

- %h: リモートホスト（ipアドレス）
- %l: リモートログ名（省略）
- %u: リモートユーザー（省略）
- %t: サーバーへのリクエスト時刻
- \"%r\": リクエストライン（メソッド、url、プロトコル）
- %>s: ステータスコード（成功時のhttpレスポンスコード）
- %b: レスポンスのバイト数
- \"%{referer}i\": リファラ
- \"%{user-agent}i\": ユーザーエージェント

上記の例は、一般的なログのフォーマットですが、必要に応じてカスタマイズすることができます。フォーマット設定後は、apacheを再起動して設定を反映させましょう。

## アクセスログの保存場所とファイル名のカスタマイズ手順

apacheのアクセスログの保存場所とファイル名をカスタマイズする方法について説明します。

デフォルトでは、apacheのアクセスログは「/var/log/apache2/access_log」などのような場所に保存されます。しかし、この場所やファイル名を変更することができます。

アクセスログの保存場所を変更するには、apacheの設定ファイルを開きます。以下のような行を探し、新しい保存場所を指定します。

```
customlog "ログの保存場所" combined
```

例えば、「/var/log/apache2/access_log」ではなく「/var/log/mysite/access_log」という場所にアクセスログを保存したい場合は、上記の行を以下のように変更します。

```
customlog "/var/log/mysite/access_log" combined
```

ファイル名をカスタマイズする場合も、同様の手順で行います。以下のような行を探し、新しいファイル名を指定します。

```
customlog "ログの保存場所/ファイル名" combined
```

例えば、ファイル名を「access.log」とし、「/var/log/mysite」に保存したい場合は、上記の行を以下のように変更します。

```
customlog "/var/log/mysite/access.log" combined
```

変更後は、apacheを再起動して設定を反映させましょう。

## ログのローテーションと古いログの削除方法

apacheのログファイルは、時間が経つにつれて肥大化していきます。このため、ログのローテーション（古いログの圧縮や削除）を定期的に行う必要があります。

ログのローテーションは、apacheの「logrotate」ユーティリティを使用して行うことができます。logrotateは、設定ファイルに基づいてログファイルのローテーションを自動的に実行するためのツールです。

まず、logrotateの設定ファイルを作成する必要があります。以下のコマンドで新しい設定ファイルを作成しましょう。

```
sudo nano /etc/logrotate.d/apache2
```

ファイルが開かれたら、以下のような内容で設定ファイルを記述します。

```
/var/log/apache2/*.log {
    weekly
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 640 root adm
    sharedscripts
    postrotate
        /etc/init.d/apache2 reload > /dev/null
    endscript
}
```

上記の設定は、apacheのログファイルを週ごとにローテーションし、52週分を保持する設定です。また、古いログは圧縮され、空のログファイルは作成されません。

設定ファイルを保存したら、logrotateを実行してローテーションを開始します。

```
sudo logrotate -f /etc/logrotate.d/apache2
```

これでapacheのアクセスログのローテーションが設定されました。定期的に設定を実行するためには、cronなどのスケジューラを使用することもできます。

## アクセスログの解析ツールと重要な情報の抽出方法

apacheのアクセスログを解析するためには、さまざまなツールが利用できます。以下では、代表的なアクセスログ解析ツールと、重要な情報を抽出する方法について説明します。

### webalizer

webalizerは、apacheログファイルを解析して詳細なレポートを作成するツールです。以下のコマンドでwebalizerをインストールできます。

```
sudo apt-get install webalizer
```

インストールが完了したら、以下のコマンドでwebalizerを実行してログファイルを解析します。

```
sudo webalizer -c /etc/webalizer/webalizer.conf -n サイト名 -o 解析結果の保存場所 ログファイルのパス
```

解析結果は、指定された保存場所に生成されます。

### awstats

awstatsも、apacheログファイルを解析して詳細なレポートを作成するツールです。以下のコマンドでawstatsをインストールできます。

```
sudo apt-get install awstats
```

インストールが完了したら、以下のコマンドでawstatsを実行してログファイルを解析します。

```
sudo awstats -config=サイト名 -update
```

解析結果は、デフォルトでは「/usr/lib/cgi-bin/awstats.pl」というcgiスクリプトによって表示されますので、ブラウザからアクセスして確認することができます。

### 重要な情報の抽出方法

アクセスログから重要な情報を抽出するためには、以下のようなコマンドを使用することができます。

- ユニークなユーザーエージェントの数をカウントする

```
cat ログファイルのパス | awk -f\" '{print $6}' | sort | uniq -c | sort -rn
```

- ユニークなipアドレスの数をカウントする

```
cat ログファイルのパス | awk '{print $1}' | sort | uniq -c | sort -rn
```

- 特定の時間帯にアクセスが集中しているかを確認する

```
cat ログファイルのパス | awk '{print $4}' | awk -f: '{print $1}' | sort | uniq -c
```

- 特定のurlにアクセスしているユーザーを抽出する

```
cat ログファイルのパス | grep "特定のurl" | cut -d' ' -f1 | sort | uniq
```

アクセスログの解析ツールや重要な情報の抽出方法は、さまざまな目的に応じて利用することができます。自分のウェブサイトのアクセスデータを定期的に解析し、パフォーマンスやセキュリティの問題を把握することが重要です。

## リモートipアドレスのブロックとセキュリティ対策のためのログ分析

最後に、リモートipアドレスのブロックとセキュリティ対策のためのログ分析について説明します。apacheのアクセスログを分析することで、不正なアクセスや攻撃を検出し、対策を行うことができます。

最初に、特定のリモートipアドレスをブロックする方法について説明します。

apacheの設定ファイルを開き、以下のような行を追加します。

```
order allow,deny
allow from all
deny from 特定のipアドレス
```

上記の例では、「特定のipアドレス」はブロックしたいipアドレスに置き換えてください。複数のipアドレスをブロックする場合は、複数の行を追加します。

設定を保存したら、apacheを再起動して設定を反映させましょう。

また、ログ分析を使用してセキュリティ対策を強化することもできます。

例えば、以下のようなログ分析コマンドを使用することで、特定のステータスコードやリクエストメソッドを持つアクセスを監視し、異常なアクセスを把握することができます。

```
cat ログファイルのパス | awk '{print $9}' | sort | uniq -c | sort -rn
cat ログファイルのパス | awk '{print $6}' | sort | uniq -c | sort -rn
```

これらのコマンドを使用することで、より詳細なログ分析が可能となり、セキュリティ対策の強化に役立ちます。

まとめると、apacheのログファイルの管理と解析について詳しく説明しました。アクセスログの有効化とフォーマット設定方法、保存場所とファイル名のカスタマイズ手順、ログのローテーションと削除方法、アクセスログの解析ツールと重要な情報の抽出方法、そしてリモートipアドレスのブロックとセキュリティ対策のためのログ分析について解説しました。

apacheを使用してウェブサーバーを構築している場合は、ログファイルの管理と解析を行うことで、ウェブサイトのパフォーマンスやセキュリティの改善につなげることができます。是非、これらの手

　

## 【Apache】関連のまとめ
https://hack-note.com/summary/apache-summary/

　

## オンラインスクールを講師として活用する！
https://hack-note.com/programming-schools/

　

## 0円でプログラミングを学ぶという選択
- [techacademyの無料体験](//af.moshimo.com/af/c/click?a_id=2612475&amp;p_id=1555&amp;pc_id=2816&amp;pl_id=22706&amp;url=https%3a%2f%2ftechacademy.jp%2fhtmlcss-trial%3futm_source%3dmoshimo%26utm_medium%3daffiliate%26utm_campaign%3dtextad)
- [オンラインスクール dmm webcamp pro](//af.moshimo.com/af/c/click?a_id=2612482&amp;p_id=1363&amp;pc_id=2297&amp;pl_id=39999&amp;guid=on)
- [レバテックカレッジ｜大学生向け 無料説明会](//af.moshimo.com/af/c/click?a_id=4071793&p_id=3198&pc_id=7488&pl_id=41848)

